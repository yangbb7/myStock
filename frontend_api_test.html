<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯APIè°ƒç”¨æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .success { color: green; background: #f0f8f0; padding: 10px; margin: 5px 0; }
        .error { color: red; background: #fdf0f0; padding: 10px; margin: 5px 0; }
        .loading { color: blue; background: #f0f0fd; padding: 10px; margin: 5px 0; }
        .info { color: #333; background: #f8f8f8; padding: 10px; margin: 5px 0; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; font-size: 12px; }
        button { padding: 12px 24px; margin: 5px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #40a9ff; }
        .status-good { color: green; font-weight: bold; }
        .status-bad { color: red; font-weight: bold; }
        .table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .table th { background: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å‰ç«¯APIè°ƒç”¨æµ‹è¯•</h1>
        <p>æ¨¡æ‹Ÿå‰ç«¯RealDataValidatorç»„ä»¶çš„å®Œæ•´APIè°ƒç”¨æµç¨‹</p>
        
        <div class="test-section">
            <h2>ğŸ¥ åç«¯æœåŠ¡è¿æ¥æµ‹è¯•</h2>
            <button onclick="testBackendConnection()">æµ‹è¯•åç«¯è¿æ¥</button>
            <div id="backend-result"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“¡ APIæ–¹æ³•æµ‹è¯•</h2>
            <button onclick="testAPIMethod()">æµ‹è¯•APIæ–¹æ³•è°ƒç”¨</button>
            <div id="api-result"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“Š è‚¡ç¥¨æ•°æ®æµ‹è¯•</h2>
            <button onclick="testStockData()">æµ‹è¯•æ‰€æœ‰è‚¡ç¥¨æ•°æ®</button>
            <div id="stock-result"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“‹ æµ‹è¯•ç»“æœæ€»è§ˆ</h2>
            <div id="summary-result"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        const testSymbols = ['000001.SZ', '000002.SZ', '600000.SH', '600036.SH'];
        
        function log(elementId, message, className = 'info') {
            const element = document.getElementById(elementId);
            const time = new Date().toLocaleTimeString();
            element.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            console.log(`[${time}] ${message}`);
        }
        
        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        // æ¨¡æ‹Ÿå‰ç«¯çš„axiosè¯·æ±‚ï¼ˆç®€åŒ–ç‰ˆï¼‰
        async function mockAxiosRequest(url, options = {}) {
            console.log(`[Mock Axios] Request to: ${url}`);
            
            // æ¨¡æ‹Ÿè¯·æ±‚æ‹¦æˆªå™¨
            const publicEndpoints = ['/health', '/data/realtime', '/data/market', '/data/symbols'];
            const isPublicEndpoint = publicEndpoints.some(endpoint => url.includes(endpoint));
            
            if (isPublicEndpoint) {
                console.log(`[Mock Axios] Public endpoint - skipping auth: ${url}`);
            } else {
                console.log(`[Mock Axios] Private endpoint - would require auth: ${url}`);
            }
            
            try {
                const response = await fetch(url, {
                    method: options.method || 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                console.log(`[Mock Axios] Response status: ${response.status}`);
                
                const data = await response.json();
                console.log(`[Mock Axios] Response data:`, data);
                
                // æ¨¡æ‹Ÿaxiosçš„å“åº”æ ¼å¼åŒ–
                return {
                    data: data,
                    status: response.status,
                    statusText: response.statusText,
                    headers: response.headers
                };
                
            } catch (error) {
                console.error(`[Mock Axios] Request failed:`, error);
                throw error;
            }
        }
        
        // æ¨¡æ‹Ÿå‰ç«¯api.data.getRealTimePriceæ–¹æ³•
        async function mockGetRealTimePrice(symbol) {
            console.log(`[Mock API] getRealTimePrice(${symbol})`);
            
            const response = await mockAxiosRequest(`${API_BASE_URL}/data/realtime/${symbol}`);
            
            // formatApiResponseå‡½æ•°çš„é€»è¾‘
            const formattedResponse = response.data;
            console.log(`[Mock API] Formatted response:`, formattedResponse);
            
            return formattedResponse;
        }
        
        // æ¨¡æ‹Ÿå‰ç«¯ç»„ä»¶çš„testSingleStockæ–¹æ³•
        async function mockTestSingleStock(symbol) {
            const startTime = Date.now();
            
            try {
                console.log(`ğŸ” [Mock Component] Testing ${symbol}...`);
                
                console.log(`ğŸ“¡ [Mock Component] Calling api.data.getRealTimePrice(${symbol})`);
                const response = await mockGetRealTimePrice(symbol);
                const latency = Date.now() - startTime;
                
                console.log(`ğŸ“¨ [Mock Component] Response for ${symbol}:`, response);
                console.log(`â±ï¸ [Mock Component] Latency: ${latency}ms`);
                
                if (response && response.success !== false) {
                    const stockData = response;
                    let current_price = 0;
                    
                    console.log(`ğŸ” [Mock Component] Processing response data:`, {
                        hasData: !!stockData.data,
                        hasCurrentPrice: !!(stockData.data && stockData.data.current_price),
                        success: stockData.success
                    });
                    
                    // ç›´æ¥ä»å®æ—¶APIå“åº”ä¸­è·å–ä»·æ ¼
                    if (stockData.data && stockData.data.current_price) {
                        current_price = stockData.data.current_price;
                        console.log(`ğŸ’° [Mock Component] Found price for ${symbol}: Â¥${current_price}`);
                        
                        return {
                            name: symbol,
                            status: 'success',
                            data: {
                                symbol,
                                name: stockData.data.name || symbol,
                                current_price,
                                timestamp: new Date().toISOString(),
                                source: 'EastMoney API'
                            },
                            latency
                        };
                    } else {
                        console.error(`âŒ [Mock Component] No price data found for ${symbol}`, stockData);
                        return {
                            name: symbol,
                            status: 'error',
                            error: 'No price data found',
                            latency
                        };
                    }
                } else {
                    const errorMsg = response?.message || 'No data received';
                    console.error(`âŒ [Mock Component] Invalid response for ${symbol}:`, response);
                    return {
                        name: symbol,
                        status: 'error',
                        error: errorMsg,
                        latency
                    };
                }
                
            } catch (error) {
                const latency = Date.now() - startTime;
                console.error(`ğŸ’¥ [Mock Component] Exception for ${symbol}:`, error);
                
                return {
                    name: symbol,
                    status: 'error',
                    error: error.message,
                    latency
                };
            }
        }
        
        async function testBackendConnection() {
            clearLog('backend-result');
            log('backend-result', 'æ­£åœ¨æµ‹è¯•åç«¯è¿æ¥...', 'loading');
            
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log('backend-result', 'âœ… åç«¯æœåŠ¡è¿æ¥æ­£å¸¸', 'success');
                    log('backend-result', `æ¶ˆæ¯: ${data.message}`, 'info');
                } else {
                    log('backend-result', 'âŒ åç«¯æœåŠ¡å“åº”å¼‚å¸¸', 'error');
                    log('backend-result', `<pre>${JSON.stringify(data, null, 2)}</pre>`, 'error');
                }
            } catch (error) {
                log('backend-result', `âŒ åç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testAPIMethod() {
            clearLog('api-result');
            log('api-result', 'æ­£åœ¨æµ‹è¯•APIæ–¹æ³•è°ƒç”¨...', 'loading');
            
            try {
                const symbol = '000001.SZ';
                const result = await mockGetRealTimePrice(symbol);
                
                log('api-result', `âœ… APIæ–¹æ³•è°ƒç”¨æˆåŠŸ`, 'success');
                log('api-result', `<pre>${JSON.stringify(result, null, 2)}</pre>`, 'info');
                
                if (result && result.data && result.data.current_price) {
                    log('api-result', `ğŸ’° ä»·æ ¼æ•°æ®: Â¥${result.data.current_price}`, 'success');
                } else {
                    log('api-result', `âš ï¸ ä»·æ ¼æ•°æ®ç»“æ„å¼‚å¸¸`, 'error');
                }
                
            } catch (error) {
                log('api-result', `âŒ APIæ–¹æ³•è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                console.error('API method test error:', error);
            }
        }
        
        async function testStockData() {
            clearLog('stock-result');
            log('stock-result', 'æ­£åœ¨æµ‹è¯•æ‰€æœ‰è‚¡ç¥¨æ•°æ®...', 'loading');
            
            const results = [];
            
            for (const symbol of testSymbols) {
                log('stock-result', `æµ‹è¯• ${symbol}...`, 'loading');
                const result = await mockTestSingleStock(symbol);
                results.push(result);
                
                if (result.status === 'success') {
                    log('stock-result', `âœ… ${symbol}: ${result.data.name} - Â¥${result.data.current_price} (${result.latency}ms)`, 'success');
                } else {
                    log('stock-result', `âŒ ${symbol}: ${result.error} (${result.latency}ms)`, 'error');
                }
            }
            
            // ç”Ÿæˆæ±‡æ€»
            const successCount = results.filter(r => r.status === 'success').length;
            const totalCount = results.length;
            
            log('stock-result', ``, 'info');
            log('stock-result', `ğŸ“Š æµ‹è¯•æ±‡æ€»: ${successCount}/${totalCount} æˆåŠŸ`, 
                successCount === totalCount ? 'success' : 'error');
            
            // æ›´æ–°æ€»è§ˆ
            updateSummary(results);
        }
        
        function updateSummary(results) {
            const summaryElement = document.getElementById('summary-result');
            const successCount = results.filter(r => r.status === 'success').length;
            const totalCount = results.length;
            
            let tableHTML = `
                <h3>ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»</h3>
                <p><span class="${successCount === totalCount ? 'status-good' : 'status-bad'}">
                    æˆåŠŸç‡: ${successCount}/${totalCount} (${(successCount/totalCount*100).toFixed(1)}%)
                </span></p>
                <table class="table">
                    <tr>
                        <th>è‚¡ç¥¨ä»£ç </th>
                        <th>çŠ¶æ€</th>
                        <th>ä»·æ ¼</th>
                        <th>å“åº”æ—¶é—´</th>
                        <th>é”™è¯¯ä¿¡æ¯</th>
                    </tr>
            `;
            
            results.forEach(result => {
                const statusClass = result.status === 'success' ? 'status-good' : 'status-bad';
                const price = result.status === 'success' ? `Â¥${result.data.current_price}` : '-';
                const error = result.status === 'error' ? result.error : '-';
                
                tableHTML += `
                    <tr>
                        <td>${result.name}</td>
                        <td class="${statusClass}">${result.status === 'success' ? 'æ­£å¸¸' : 'å¼‚å¸¸'}</td>
                        <td>${price}</td>
                        <td>${result.latency}ms</td>
                        <td>${error}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</table>';
            
            if (successCount === totalCount) {
                tableHTML += `
                    <div class="success">
                        ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å¦‚æœå‰ç«¯ä»æ˜¾ç¤ºå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ï¼š
                        <ul>
                            <li>æµè§ˆå™¨ç¼“å­˜ - ç¡¬åˆ·æ–°é¡µé¢ (Ctrl+Shift+R)</li>
                            <li>æµè§ˆå™¨æ§åˆ¶å° - æŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯</li>
                            <li>ç½‘ç»œé¢æ¿ - æ£€æŸ¥APIè¯·æ±‚æ˜¯å¦æˆåŠŸ</li>
                        </ul>
                    </div>
                `;
            } else {
                tableHTML += `
                    <div class="error">
                        âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆå‰ç«¯æ˜¾ç¤ºå¼‚å¸¸çŠ¶æ€
                    </div>
                `;
            }
            
            summaryElement.innerHTML = tableHTML;
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•');
            testBackendConnection();
        };
    </script>
</body>
</html>